<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Citation Correction Bot</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,400&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --ink: #1a1a2e;
                --ink-light: #2d2d44;
                --ink-muted: #6b6b80;
                --ivory: #f8f6f1;
                --ivory-deep: #efece4;
                --cream: #fdfcf9;
                --gold: #b8860b;
                --gold-light: #d4a843;
                --gold-faint: rgba(184, 134, 11, 0.08);
                --border: #e2dfd6;
                --border-light: #eceadf;
                --shadow: rgba(26, 26, 46, 0.06);
                --shadow-md: rgba(26, 26, 46, 0.1);
                --success: #2e7d32;
                --font-display: "Cormorant Garamond", "Georgia", serif;
                --font-body: "DM Sans", system-ui, sans-serif;
                --radius: 2px;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            html, body {
                height: 100%;
                overflow: hidden;
            }

            body {
                font-family: var(--font-body);
                background: var(--ivory);
                color: var(--ink);
                display: flex;
                justify-content: center;
                align-items: center;
                background-image:
                    radial-gradient(circle at 20% 50%, rgba(184, 134, 11, 0.03) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(26, 26, 46, 0.02) 0%, transparent 50%);
                cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%231a1a2e' stroke-width='1.5'%3E%3Ccircle cx='10' cy='10' r='7'/%3E%3Cline x1='15' y1='15' x2='22' y2='22'/%3E%3C/svg%3E") 4 4, auto;
            }

            button, input, .example-chip, .style-btn, .copy-btn, #send-btn {
                cursor: pointer;
            }

            #container {
                width: 100%;
                max-width: 780px;
                height: calc(100vh - 48px);
                max-height: 800px;
                display: flex;
                flex-direction: column;
                background: var(--cream);
                border: 1px solid var(--border);
                box-shadow:
                    0 1px 3px var(--shadow),
                    0 8px 32px var(--shadow);
                position: relative;
            }

            /* --- Top Bar --- */
            #top-bar {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 20px 28px 16px;
                border-bottom: 1px solid var(--border);
                flex-shrink: 0;
            }

            #top-bar h1 {
                font-family: var(--font-display);
                font-size: 1.5rem;
                font-weight: 600;
                letter-spacing: -0.01em;
                color: var(--ink);
                line-height: 1;
            }

            #top-bar h1 span {
                color: var(--gold);
            }

            .style-switcher {
                display: flex;
                align-items: center;
                gap: 0;
                border: 1px solid var(--border);
                border-radius: var(--radius);
                overflow: hidden;
                flex-shrink: 0;
            }

            .style-btn {
                padding: 7px 14px;
                font-family: var(--font-body);
                font-size: 0.7rem;
                font-weight: 500;
                letter-spacing: 0.04em;
                text-transform: uppercase;
                background: transparent;
                color: var(--ink-muted);
                border: none;
                transition: all 0.2s ease;
                position: relative;
            }

            .style-btn:not(:last-child) {
                border-right: 1px solid var(--border);
            }

            .style-btn:hover {
                color: var(--ink);
                background: var(--ivory);
            }

            .style-btn.active {
                color: var(--ink);
                background: var(--ivory-deep);
                font-weight: 500;
            }

            .style-btn.active::after {
                content: "";
                position: absolute;
                bottom: 0;
                left: 20%;
                right: 20%;
                height: 1.5px;
                background: var(--gold);
            }

            /* --- Examples --- */
            #examples-row {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 12px 28px;
                border-bottom: 1px solid var(--border-light);
                flex-shrink: 0;
                overflow-x: auto;
            }

            .examples-label {
                font-size: 0.68rem;
                font-weight: 500;
                color: var(--ink-muted);
                text-transform: uppercase;
                letter-spacing: 0.06em;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .example-chip {
                padding: 5px 12px;
                font-family: var(--font-body);
                font-size: 0.72rem;
                font-weight: 400;
                color: var(--ink-light);
                background: var(--ivory);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                transition: all 0.15s ease;
                white-space: nowrap;
                flex-shrink: 0;
                letter-spacing: 0;
                text-transform: none;
            }

            .example-chip:hover {
                border-color: var(--gold-light);
                color: var(--ink);
                background: var(--gold-faint);
            }

            /* --- Messages --- */
            #messages {
                flex: 1;
                overflow-y: auto;
                padding: 24px 28px;
                display: flex;
                flex-direction: column;
                gap: 20px;
                min-height: 0;
            }

            #messages::-webkit-scrollbar {
                width: 4px;
            }
            #messages::-webkit-scrollbar-track {
                background: transparent;
            }
            #messages::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 4px;
            }

            .empty-state {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 12px;
                opacity: 0.5;
                user-select: none;
            }

            .empty-state svg {
                width: 36px;
                height: 36px;
                stroke: var(--ink-muted);
                stroke-width: 1.2;
                fill: none;
            }

            .empty-state p {
                font-family: var(--font-display);
                font-size: 1.05rem;
                font-style: italic;
                color: var(--ink-muted);
            }

            .msg {
                max-width: 88%;
                animation: msgIn 0.35s cubic-bezier(0.16, 1, 0.3, 1) both;
            }

            @keyframes msgIn {
                from { opacity: 0; transform: translateY(12px) scale(0.98); }
                to   { opacity: 1; transform: translateY(0) scale(1); }
            }

            .msg.user {
                align-self: flex-end;
            }

            .msg.assistant {
                align-self: flex-start;
            }

            .msg .role {
                font-size: 0.62rem;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                color: var(--ink-muted);
                margin-bottom: 5px;
            }

            .msg.user .role {
                text-align: right;
            }

            .msg .content {
                font-size: 0.88rem;
                line-height: 1.65;
                white-space: pre-wrap;
                word-break: break-word;
            }

            .msg.user .content {
                background: var(--ink);
                color: var(--ivory);
                padding: 12px 16px;
                border-radius: var(--radius);
                font-size: 0.85rem;
            }

            .msg.assistant .content {
                background: var(--ivory);
                border: 1px solid var(--border);
                padding: 14px 18px;
                border-radius: var(--radius);
                border-left: 2.5px solid var(--gold);
            }

            .corrected-block {
                margin-top: 12px;
                padding: 14px 16px;
                background: var(--gold-faint);
                border: 1px solid var(--gold-light);
                border-radius: var(--radius);
            }

            .corrected-block .corrected-label {
                font-size: 0.65rem;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.06em;
                color: var(--gold);
                margin-bottom: 8px;
            }

            .corrected-block .corrected-text {
                font-size: 0.85rem;
                line-height: 1.6;
                color: var(--ink);
                white-space: pre-wrap;
                word-break: break-word;
                padding: 10px 12px;
                background: var(--cream);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                user-select: all;
            }

            .copy-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                width: 100%;
                margin-top: 10px;
                padding: 8px 0;
                font-family: var(--font-body);
                font-size: 0.72rem;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.04em;
                color: var(--ink);
                background: var(--cream);
                border: 1px solid var(--gold-light);
                border-radius: var(--radius);
                transition: all 0.15s ease;
            }

            .copy-btn svg {
                width: 14px;
                height: 14px;
                stroke: currentColor;
                stroke-width: 2;
                fill: none;
            }

            .copy-btn:hover {
                background: var(--gold);
                color: var(--cream);
                border-color: var(--gold);
            }

            .copy-btn.copied {
                background: var(--success);
                color: #fff;
                border-color: var(--success);
                animation: copyPulse 0.3s ease;
            }

            @keyframes copyPulse {
                0%   { transform: scale(1); }
                50%  { transform: scale(1.03); }
                100% { transform: scale(1); }
            }

            /* --- Loading dots --- */
            .loading-dots {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                margin-left: 4px;
            }

            .loading-dots span {
                width: 5px;
                height: 5px;
                border-radius: 50%;
                background: var(--ink-muted);
                display: inline-block;
                animation: bounce 0.6s ease-in-out infinite;
            }

            .loading-dots span:nth-child(2) { animation-delay: 0.15s; }
            .loading-dots span:nth-child(3) { animation-delay: 0.3s; }

            @keyframes bounce {
                0%, 80%, 100% { transform: translateY(0); }
                40% { transform: translateY(-6px); }
            }

            /* --- Input --- */
            #input-area {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px 28px 20px;
                border-top: 1px solid var(--border);
                flex-shrink: 0;
                background: var(--cream);
            }

            #user-input {
                flex: 1;
                padding: 10px 0;
                border: none;
                border-bottom: 1.5px solid var(--border);
                font-family: var(--font-display);
                font-size: 1rem;
                color: var(--ink);
                outline: none;
                background: transparent;
                transition: border-color 0.2s ease;
                cursor: text;
            }

            #user-input::placeholder {
                color: var(--ink-muted);
                font-style: italic;
                opacity: 0.6;
            }

            #user-input:focus {
                border-bottom-color: var(--gold);
            }

            #send-btn {
                padding: 9px 22px;
                background: var(--ink);
                color: var(--ivory);
                border: none;
                border-radius: var(--radius);
                font-family: var(--font-body);
                font-size: 0.7rem;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.06em;
                transition: all 0.2s ease;
                flex-shrink: 0;
            }

            #send-btn:hover {
                background: var(--ink-light);
                box-shadow: 0 2px 8px var(--shadow-md);
            }

            #send-btn:disabled {
                opacity: 0.25;
                cursor: default;
                box-shadow: none;
            }

            #send-btn:active:not(:disabled) {
                transform: scale(0.97);
            }

            /* --- Footer accent --- */
            #container::after {
                content: "";
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: linear-gradient(90deg, var(--gold), var(--gold-light), var(--gold));
                opacity: 0.6;
            }

            /* --- Responsive --- */
            @media (max-width: 840px) {
                #container {
                    max-width: 100%;
                    height: 100vh;
                    max-height: 100vh;
                    border: none;
                    box-shadow: none;
                }
                #top-bar { padding: 16px 20px 14px; }
                #top-bar h1 { font-size: 1.25rem; }
                #examples-row { padding: 10px 20px; }
                #messages { padding: 20px; }
                #input-area { padding: 14px 20px 18px; }
                .style-btn { padding: 6px 10px; font-size: 0.65rem; }
            }
        </style>
    </head>
    <body>
        <div id="container">
            <div id="top-bar">
                <h1>Citation<span>.</span> Corrector</h1>
                <div class="style-switcher">
                    <button class="style-btn active" data-style="apa">APA 7th</button>
                    <button class="style-btn" data-style="mla">MLA 9th</button>
                    <button class="style-btn" data-style="chicago">Chicago 17th</button>
                </div>
            </div>
            <div id="examples-row">
                <span class="examples-label">Try:</span>
            </div>
            <div id="messages">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
                        <path d="M8 7h6" />
                        <path d="M8 11h8" />
                    </svg>
                    <p>Paste your citations to get corrections</p>
                </div>
            </div>
            <div id="input-area">
                <input
                    type="text"
                    id="user-input"
                    placeholder="Paste a citation or reference entry to correct..."
                    autocomplete="off"
                />
                <button id="send-btn">Check</button>
            </div>
        </div>

        <script>
            const messages = document.getElementById("messages");
            const userInput = document.getElementById("user-input");
            const sendBtn = document.getElementById("send-btn");
            const examplesRow = document.getElementById("examples-row");
            const styleBtns = document.querySelectorAll(".style-btn");
            let sessionId = null;
            let currentStyle = "apa";

            const EXAMPLES = {
                apa: [
                    { label: "Fix missing page number", text: 'According to Smith (2020), "the results were significant" and the study confirmed earlier findings (Jones & Lee, 2019).' },
                    { label: "Fix et al. usage", text: 'The research (Smith, Jones, Lee, & Park, 2021) showed that "cognitive load theory explains most variance."' },
                    { label: "Fix reference capitalization", text: "Smith, J. (2020). Effects Of Sleep. journal of psychology, 105(3), 234." },
                ],
                mla: [
                    { label: "Fix year & comma errors", text: "Smith argues that memory declines with age (Smith, 2020, p. 45)." },
                    { label: "Fix comma + p. errors", text: 'According to Lee, the effect was significant (Lee, 34). Smith wrote that "results were positive" (Smith, p. 12).' },
                    { label: "Fix Works Cited entry", text: "Works Cited: John Smith. How to Cite. Penguin, 2020." },
                ],
                chicago: [
                    { label: "Fix parenthetical to footnote", text: "The study found strong effects (Smith 2020, 45). Later work confirmed this (Jones 2019)." },
                    { label: "Fix note name order", text: 'The data support the hypothesis.\u00B2 \u00B2 Smith, John. Introduction to Statistics (New York: Norton, 2020), 78.' },
                    { label: "Fix bibliography author", text: "Bibliography: John Smith. Introduction to Statistics. New York: Norton, 2020." },
                ],
            };

            /* --- Style Switcher --- */
            styleBtns.forEach(btn => {
                btn.addEventListener("click", () => {
                    styleBtns.forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    currentStyle = btn.dataset.style;
                    renderExamples();
                });
            });

            function renderExamples() {
                examplesRow.querySelectorAll(".example-chip").forEach(el => el.remove());
                EXAMPLES[currentStyle].forEach(ex => {
                    const btn = document.createElement("button");
                    btn.className = "example-chip";
                    btn.textContent = ex.label;
                    btn.title = ex.text;
                    btn.addEventListener("click", () => {
                        userInput.value = ex.text;
                        userInput.focus();
                    });
                    examplesRow.appendChild(btn);
                });
            }
            renderExamples();

            /* --- Messages --- */
            function clearEmptyState() {
                const empty = messages.querySelector(".empty-state");
                if (empty) empty.remove();
            }

            function escapeHtml(str) {
                return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }

            function formatResponse(text) {
                const marker = "Corrected citation:";
                const idx = text.toLowerCase().indexOf(marker.toLowerCase());
                if (idx === -1) return escapeHtml(text);

                const before = text.substring(0, idx).trim();
                const after = text.substring(idx + marker.length).trim();

                return escapeHtml(before) +
                    '<div class="corrected-block">' +
                        '<div class="corrected-label">Corrected citation</div>' +
                        '<div class="corrected-text">' + escapeHtml(after) + '</div>' +
                        '<button class="copy-btn" onclick="copyCorrection(this)">' +
                            '<svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>' +
                            '<span>Copy to clipboard</span>' +
                        '</button>' +
                    '</div>';
            }

            function copyCorrection(btn) {
                const text = btn.parentElement.querySelector(".corrected-text").textContent;
                navigator.clipboard.writeText(text).then(() => {
                    btn.innerHTML =
                        '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>' +
                        '<span>Copied!</span>';
                    btn.classList.add("copied");
                    setTimeout(() => {
                        btn.innerHTML =
                            '<svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>' +
                            '<span>Copy to clipboard</span>';
                        btn.classList.remove("copied");
                    }, 2000);
                });
            }

            let msgCount = 0;
            function addMessage(role, text, isLoading = false) {
                clearEmptyState();
                msgCount++;
                const div = document.createElement("div");
                div.className =
                    "msg " +
                    (role === "you" ? "user" : "assistant") +
                    (isLoading ? " loading" : "");
                div.style.animationDelay = (msgCount * 0.05) + "s";
                if (isLoading) {
                    div.innerHTML =
                        '<div class="role">Corrector</div>' +
                        '<div class="content">' +
                            '<em>Reviewing</em>' +
                            '<span class="loading-dots"><span></span><span></span><span></span></span>' +
                        '</div>';
                } else {
                    div.innerHTML =
                        '<div class="role">' +
                        (role === "you" ? "You" : "Corrector") +
                        '</div><div class="content">' +
                        escapeHtml(text) +
                        "</div>";
                }
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
                return div;
            }

            /* --- Send --- */
            async function send() {
                const text = userInput.value.trim();
                if (!text) return;

                userInput.value = "";
                sendBtn.disabled = true;
                addMessage("you", text);
                const loading = addMessage(
                    "Citation Checker",
                    "Reviewing",
                    true,
                );

                try {
                    const res = await fetch("/chat", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            message: text,
                            session_id: sessionId,
                            style: currentStyle,
                        }),
                    });
                    const data = await res.json();
                    sessionId = data.session_id;
                    loading.querySelector(".content").innerHTML =
                        formatResponse(data.response);
                    loading.classList.remove("loading");
                } catch (e) {
                    loading.querySelector(".content").textContent =
                        "Error: " + e.message;
                    loading.classList.remove("loading");
                }
                sendBtn.disabled = false;
                userInput.focus();
            }

            sendBtn.addEventListener("click", send);
            userInput.addEventListener("keydown", function (e) {
                if (e.key === "Enter") send();
            });
            userInput.focus();
        </script>
    </body>
</html>
