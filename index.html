<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CiteFix</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,400&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --ink: #1a1a2e;
                --ink-light: #2d2d44;
                --ink-muted: #6b6b80;
                --ivory: #f8f6f1;
                --ivory-deep: #efece4;
                --cream: #fdfcf9;
                --gold: #b8860b;
                --border: #e2dfd6;
                --border-light: #eceadf;
                --shadow: rgba(26, 26, 46, 0.06);
                --success: #2e7d32;
                --font-display: "Cormorant Garamond", "Georgia", serif;
                --font-body: "DM Sans", system-ui, sans-serif;
                --radius: 1px;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            html, body {
                height: 100%;
                overflow: hidden;
            }

            body {
                font-family: var(--font-body);
                background: var(--ivory);
                color: var(--ink);
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%231a1a2e' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M17 3l4 4L7.5 20.5 2 22l1.5-5.5L17 3z'/%3E%3Cpath d='M15 5l4 4'/%3E%3C/svg%3E") 1 19, auto;
            }

            button, input, .example-chip, .style-btn, .copy-btn, #send-btn {
                cursor: pointer;
            }

            #user-input {
                cursor: text;
            }

            #container {
                width: 100%;
                max-width: 780px;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: var(--cream);
                border-left: 1px solid var(--border);
                border-right: 1px solid var(--border);
            }

            /* --- Header --- */
            #top-bar {
                display: flex;
                flex-direction: column;
                padding: 20px 28px 0;
                flex-shrink: 0;
            }

            #top-bar-row {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 16px;
            }

            #top-bar h1 {
                font-family: var(--font-display);
                font-size: 1.5rem;
                font-weight: 600;
                letter-spacing: -0.01em;
                color: var(--ink);
                line-height: 1;
            }

            #top-bar h1 span {
                color: var(--gold);
            }

            /* --- Style Tabs --- */
            .style-switcher {
                display: flex;
                align-items: center;
                gap: 0;
                flex-shrink: 0;
            }

            .style-btn {
                padding: 6px 14px;
                font-family: var(--font-body);
                font-size: 0.78rem;
                font-weight: 400;
                background: transparent;
                color: var(--ink-muted);
                border: none;
                border-bottom: 1.5px solid transparent;
                transition: all 0.2s ease;
                position: relative;
            }

            .style-btn:hover {
                color: var(--ink);
            }

            .style-btn.active {
                color: var(--ink);
                font-weight: 500;
                border-bottom-color: var(--gold);
            }

            /* --- Description --- */
            .style-description {
                font-size: 0.75rem;
                color: var(--ink-muted);
                font-style: italic;
                padding: 10px 28px 12px;
                border-bottom: 1px solid var(--border-light);
                flex-shrink: 0;
            }

            /* --- Examples --- */
            #examples-row {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px 28px;
                border-bottom: 1px solid var(--border-light);
                flex-shrink: 0;
                overflow-x: auto;
            }

            .example-chip {
                padding: 4px 10px;
                font-family: var(--font-body);
                font-size: 0.7rem;
                font-weight: 400;
                color: var(--ink-muted);
                background: transparent;
                border: 1px solid var(--border);
                border-radius: var(--radius);
                transition: all 0.15s ease;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .example-chip:hover {
                border-color: var(--ink-muted);
                color: var(--ink);
            }

            /* --- Messages --- */
            #messages {
                flex: 1;
                overflow-y: auto;
                padding: 24px 28px;
                display: flex;
                flex-direction: column;
                gap: 16px;
                min-height: 0;
            }

            #messages::-webkit-scrollbar {
                width: 4px;
            }
            #messages::-webkit-scrollbar-track {
                background: transparent;
            }
            #messages::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 4px;
            }

            .empty-state {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 12px;
                opacity: 0.4;
                user-select: none;
            }

            .empty-state svg {
                width: 32px;
                height: 32px;
                stroke: var(--ink-muted);
                stroke-width: 1.2;
                fill: none;
            }

            .empty-state p {
                font-family: var(--font-display);
                font-size: 1rem;
                font-style: italic;
                color: var(--ink-muted);
            }

            .msg {
                max-width: 88%;
                animation: msgIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) both;
            }

            @keyframes msgIn {
                from { opacity: 0; transform: translateY(8px); }
                to   { opacity: 1; transform: translateY(0); }
            }

            .msg.user {
                align-self: flex-end;
            }

            .msg.assistant {
                align-self: flex-start;
            }

            .msg .content {
                font-size: 0.86rem;
                line-height: 1.65;
                white-space: pre-wrap;
                word-break: break-word;
            }

            .msg.user .content {
                background: var(--ivory-deep);
                color: var(--ink);
                padding: 10px 14px;
                border-radius: var(--radius);
                font-size: 0.84rem;
            }

            .msg.assistant .content {
                padding: 4px 0 4px 14px;
                border-left: 1.5px solid var(--border);
            }

            /* --- Corrected block --- */
            .corrected-block {
                margin-top: 14px;
                padding-top: 12px;
                border-top: 1px solid var(--border-light);
            }

            .corrected-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 6px;
            }

            .corrected-label {
                font-size: 0.68rem;
                font-weight: 400;
                color: var(--ink-muted);
            }

            .corrected-text {
                font-size: 0.84rem;
                line-height: 1.6;
                font-weight: 500;
                color: var(--ink);
                white-space: pre-wrap;
                word-break: break-word;
                user-select: all;
            }

            .copy-btn {
                display: inline-flex;
                align-items: center;
                padding: 2px;
                background: none;
                border: none;
                color: var(--ink-muted);
                transition: color 0.15s ease;
            }

            .copy-btn svg {
                width: 14px;
                height: 14px;
                stroke: currentColor;
                stroke-width: 2;
                fill: none;
            }

            .copy-btn:hover {
                color: var(--ink);
            }

            .copy-btn.copied {
                color: var(--success);
            }

            /* --- Loading dots --- */
            .loading-dots {
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }

            .loading-dots span {
                width: 4px;
                height: 4px;
                border-radius: 50%;
                background: var(--ink-muted);
                display: inline-block;
                animation: bounce 0.6s ease-in-out infinite;
            }

            .loading-dots span:nth-child(2) { animation-delay: 0.15s; }
            .loading-dots span:nth-child(3) { animation-delay: 0.3s; }

            @keyframes bounce {
                0%, 80%, 100% { transform: translateY(0); }
                40% { transform: translateY(-5px); }
            }

            /* --- Input --- */
            #input-area {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 14px 28px 18px;
                border-top: 1px solid var(--border);
                flex-shrink: 0;
                background: var(--cream);
            }

            #user-input {
                flex: 1;
                padding: 8px 0;
                border: none;
                border-bottom: 1.5px solid var(--border);
                font-family: var(--font-display);
                font-size: 1rem;
                color: var(--ink);
                outline: none;
                background: transparent;
                transition: border-color 0.2s ease;
            }

            #user-input::placeholder {
                color: var(--ink-muted);
                font-style: italic;
                opacity: 0.5;
            }

            #user-input:focus {
                border-bottom-color: var(--ink-muted);
            }

            #send-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 32px;
                height: 32px;
                background: none;
                color: var(--ink-muted);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                transition: all 0.15s ease;
                flex-shrink: 0;
            }

            #send-btn svg {
                width: 16px;
                height: 16px;
                stroke: currentColor;
                stroke-width: 2;
                fill: none;
            }

            #send-btn:hover {
                color: var(--ink);
                border-color: var(--ink-muted);
            }

            #send-btn:disabled {
                opacity: 0.2;
                cursor: default;
            }

            #send-btn:active:not(:disabled) {
                transform: scale(0.95);
            }

            /* --- Responsive --- */
            @media (max-width: 840px) {
                #container {
                    max-width: 100%;
                    border: none;
                }
                #top-bar { padding: 16px 20px 0; }
                #top-bar h1 { font-size: 1.25rem; }
                .style-description { padding: 8px 20px 10px; }
                #examples-row { padding: 8px 20px; }
                #messages { padding: 20px; }
                #input-area { padding: 12px 20px 16px; }
                .style-btn { padding: 5px 10px; font-size: 0.72rem; }
            }
        </style>
    </head>
    <body>
        <div id="container">
            <div id="top-bar">
                <div id="top-bar-row">
                    <h1>Cite<span>.</span>Fix</h1>
                    <div class="style-switcher">
                        <button class="style-btn active" data-style="apa">APA 7th</button>
                        <button class="style-btn" data-style="mla">MLA 9th</button>
                        <button class="style-btn" data-style="chicago">Chicago 17th</button>
                    </div>
                </div>
            </div>
            <div class="style-description">Select a citation standard â€” paste your text below to check formatting</div>
            <div id="examples-row"></div>
            <div id="messages">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
                        <path d="M8 7h6" />
                        <path d="M8 11h8" />
                    </svg>
                    <p>Paste a citation to check formatting</p>
                </div>
            </div>
            <div id="input-area">
                <input
                    type="text"
                    id="user-input"
                    placeholder="Paste a citation or reference entry..."
                    autocomplete="off"
                />
                <button id="send-btn">
                    <svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                </button>
            </div>
        </div>

        <script>
            const messages = document.getElementById("messages");
            const userInput = document.getElementById("user-input");
            const sendBtn = document.getElementById("send-btn");
            const examplesRow = document.getElementById("examples-row");
            const styleBtns = document.querySelectorAll(".style-btn");
            let sessionId = null;
            let currentStyle = "apa";

            const EXAMPLES = {
                apa: [
                    { label: "Fix missing page number", text: 'According to Smith (2020), "the results were significant" and the study confirmed earlier findings (Jones & Lee, 2019).' },
                    { label: "Fix et al. usage", text: 'The research (Smith, Jones, Lee, & Park, 2021) showed that "cognitive load theory explains most variance."' },
                    { label: "Fix reference capitalization", text: "Smith, J. (2020). Effects Of Sleep. journal of psychology, 105(3), 234." },
                    { label: "Fix DOI format", text: "Smith, J. (2020). Effects of sleep. Journal of Psychology, 105(3), 234. doi:10.1037/abc123" },
                ],
                mla: [
                    { label: "Fix year & comma errors", text: "Smith argues that memory declines with age (Smith, 2020, p. 45)." },
                    { label: "Fix comma + p. errors", text: 'According to Lee, the effect was significant (Lee, 34). Smith wrote that "results were positive" (Smith, p. 12).' },
                    { label: "Fix Works Cited entry", text: "Works Cited: John Smith. How to Cite. Penguin, 2020." },
                    { label: "Fix multi-author format", text: "Smith, Jones, and Lee argue the data supports the claim (Smith, Jones, and Lee 42)." },
                ],
                chicago: [
                    { label: "Fix parenthetical to footnote", text: "The study found strong effects (Smith 2020, 45). Later work confirmed this (Jones 2019)." },
                    { label: "Fix note name order", text: 'The data support the hypothesis.\u00B2 \u00B2 Smith, John. Introduction to Statistics (New York: Norton, 2020), 78.' },
                    { label: "Fix bibliography author", text: "Bibliography: John Smith. Introduction to Statistics. New York: Norton, 2020." },
                    { label: "Fix ibid. misuse", text: "The results are clear.\u00B3 Later analysis confirmed the findings.\u2074 \u00B3 Ibid. \u2074 Smith, Statistics, 90." },
                ],
            };

            /* --- Style Switcher --- */
            styleBtns.forEach(btn => {
                btn.addEventListener("click", () => {
                    styleBtns.forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    currentStyle = btn.dataset.style;
                    renderExamples();
                });
            });

            function renderExamples() {
                examplesRow.innerHTML = "";
                EXAMPLES[currentStyle].forEach(ex => {
                    const btn = document.createElement("button");
                    btn.className = "example-chip";
                    btn.textContent = ex.label;
                    btn.title = ex.text;
                    btn.addEventListener("click", () => {
                        userInput.value = ex.text;
                        userInput.focus();
                    });
                    examplesRow.appendChild(btn);
                });
            }
            renderExamples();

            /* --- Messages --- */
            function clearEmptyState() {
                const empty = messages.querySelector(".empty-state");
                if (empty) empty.remove();
            }

            function escapeHtml(str) {
                return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }

            function formatResponse(text) {
                const marker = "Corrected citation:";
                const idx = text.toLowerCase().indexOf(marker.toLowerCase());
                if (idx === -1) return escapeHtml(text);

                const before = text.substring(0, idx).trim();
                const after = text.substring(idx + marker.length).trim();

                return escapeHtml(before) +
                    '<div class="corrected-block">' +
                        '<div class="corrected-header">' +
                            '<span class="corrected-label">Corrected</span>' +
                            '<button class="copy-btn" onclick="copyCorrection(this)">' +
                                '<svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>' +
                            '</button>' +
                        '</div>' +
                        '<div class="corrected-text">' + escapeHtml(after) + '</div>' +
                    '</div>';
            }

            function copyCorrection(btn) {
                const text = btn.closest(".corrected-block").querySelector(".corrected-text").textContent;
                navigator.clipboard.writeText(text).then(() => {
                    btn.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>';
                    btn.classList.add("copied");
                    setTimeout(() => {
                        btn.innerHTML = '<svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
                        btn.classList.remove("copied");
                    }, 1500);
                });
            }

            function addMessage(role, text, isLoading = false) {
                clearEmptyState();
                const div = document.createElement("div");
                div.className =
                    "msg " +
                    (role === "you" ? "user" : "assistant") +
                    (isLoading ? " loading" : "");
                if (isLoading) {
                    div.innerHTML =
                        '<div class="content">' +
                            '<span class="loading-dots"><span></span><span></span><span></span></span>' +
                        '</div>';
                } else {
                    div.innerHTML =
                        '<div class="content">' + escapeHtml(text) + '</div>';
                }
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
                return div;
            }

            /* --- Send --- */
            async function send() {
                const text = userInput.value.trim();
                if (!text) return;

                userInput.value = "";
                sendBtn.disabled = true;
                addMessage("you", text);
                const loading = addMessage("bot", "", true);

                try {
                    const res = await fetch("/chat", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            message: text,
                            session_id: sessionId,
                            style: currentStyle,
                        }),
                    });
                    const data = await res.json();
                    sessionId = data.session_id;
                    loading.querySelector(".content").innerHTML =
                        formatResponse(data.response);
                    loading.classList.remove("loading");
                } catch (e) {
                    loading.querySelector(".content").textContent =
                        "Error: " + e.message;
                    loading.classList.remove("loading");
                }
                sendBtn.disabled = false;
                userInput.focus();
            }

            sendBtn.addEventListener("click", send);
            userInput.addEventListener("keydown", function (e) {
                if (e.key === "Enter") send();
            });
            userInput.focus();
        </script>
    </body>
</html>
